appContext.controller("UpdateController",["$scope","$state","$rootScope","MenuService","ConnectionService","LoadingService","BuzcardService","ContactsService","$ionicPlatform","$ionicHistory","$cordovaSQLite","$location",function($scope,$state,$rootScope,MenuService,ConnectionService,LoadingService,BuzcardService,ContactsService,$ionicPlatform,$ionicHistory,$cordovaSQLite,$location){var db=null;$ionicPlatform.ready(function(){if(window.cordova){db=$cordovaSQLite.openDB("buzcard.db")}else{db=window.openDatabase("buzcard.db","1","my",1024*1024*10)}});$scope.no=function(){LoadingService.dismiss()};$scope.yes=function(){LoadingService.loading("Synchronisation...");var dateSynchronisation=MenuService.getLocalStorage("dateSynchronisation");if(dateSynchronisation!=false){ConnectionService.isConnected(db,function(){BuzcardService.getProfil().success(function(data,status,headers,config){if(data!=""){var profil=data.response.virtual_card;console.log(profil);$rootScope.fileLocaltion=profil.photofilelocation.substr(2,profil.photofilelocation.lastIndexOf("/")-1);$rootScope.idProfil=profil.id;BuzcardService.updateProfil(db,data.response.virtual_card,function(){BuzcardService.downloadPhotoProfil(profil.photofilelocation,profil.id,function(url){ContactsService.getContactsEdited().success(function(data,status,headers,config){var nbContacts=0;if(data.contacts.contact instanceof Array){nbContacts=data.contacts.contact.length;console.log("++++++++"+data.contacts.contact)}else if(data.contacts.contact instanceof Object){nbContacts=1;console.log("+++++"+data.contacts.contact)}if(nbContacts==0){var dateSynchronisation=MenuService.getDateUS();MenuService.setLocalStorage("dateSynchronisation",dateSynchronisation);LoadingService.dismiss();MenuService.setLocalStorage("ReloadContactList",1);console.warn($state.current.name=="app.buzcard");if($state.current.name=="app.buzcard")$state.go($state.current,{},{reload:true});else $state.go("app.buzcard",{},{reload:true})}else{ContactsService.insertOrUpdateContacts(db,0,nbContacts,data.contacts.contact,function(){ContactsService.downloadPhotoContactsAtSynchro(db,data.contacts.contact,function(){ContactsService.emptyGroupTable(db,function(){ContactsService.getGroup().success(function(data,status,headers,config){if(data.lists.list instanceof Array){ContactsService.insertBulkGroupe(db,data.lists.list,function(){ContactsService.getCreditParrainage(function(credit){MenuService.setLocalStorage("credit",credit);var dateSynchronisation=MenuService.getDateUS();MenuService.setLocalStorage("dateSynchronisation",dateSynchronisation);LoadingService.dismiss();MenuService.setLocalStorage("ReloadContactList",1);MenuService.setLocalStorage("ReloadContactList",1);console.warn($state.current.name=="app.buzcard");if($state.current.name=="app.buzcard")$state.go($state.current,{},{reload:true});else $state.go("app.buzcard",{},{reload:true})})})}else{ContactsService.insertIntoGroupTable(db,data.lists.list,function(){ContactsService.getCreditParrainage(function(credit){MenuService.setLocalStorage("credit",credit);var dateSynchronisation=MenuService.getDateUS();MenuService.setLocalStorage("dateSynchronisation",dateSynchronisation);LoadingService.dismiss();MenuService.setLocalStorage("ReloadContactList",1);MenuService.setLocalStorage("ReloadContactList",1);if($state.current.name=="app.buzcard")$state.go($state.current,{},{reload:true});else $state.go("app.buzcard",{},{reload:true})})})}}).error(function(data,status,headers,config){console.log("error "+status)})})})})}}).error(function(data,status,headers,config){console.log("error "+status)})})})}else{console.info("data empty");ContactsService.getContactsEdited().success(function(data,status,headers,config){var nbContacts=0;if(data.contacts.contact instanceof Array){nbContacts=data.contacts.contact.length;console.log("========="+data.contacts.contact)}else if(data.contacts.contact instanceof Object){nbContacts=1;console.log("======");console.log(data.contacts.contact)}if(nbContacts==0){console.log("there is no contacts");var dateSynchronisation=MenuService.getDateUS();MenuService.setLocalStorage("dateSynchronisation",dateSynchronisation);ContactsService.getCreditParrainage(function(credit){MenuService.setLocalStorage("credit",credit);var dateSynchronisation=MenuService.getDateUS();MenuService.setLocalStorage("dateSynchronisation",dateSynchronisation);LoadingService.dismiss();$state.go("app.buzcard")})}else{console.log("there is contacts");var contactDataServer=data.contacts.contact;ContactsService.insertOrUpdateContacts(db,0,nbContacts,contactDataServer,function(){console.error(JSON.stringify(contactDataServer));ContactsService.downloadPhotoContactsAtSynchro(db,contactDataServer,function(){ContactsService.emptyGroupTable(db,function(){ContactsService.getGroup().success(function(data,status,headers,config){console.error("get group d'accord.....");if(data.lists.list instanceof Array){console.error("group instance of array.....");ContactsService.insertBulkGroupe(db,data.lists.list,function(){ContactsService.getCreditParrainage(function(credit){MenuService.setLocalStorage("credit",credit);var dateSynchronisation=MenuService.getDateUS();MenuService.setLocalStorage("dateSynchronisation",dateSynchronisation);console.log(data);LoadingService.dismiss();MenuService.setLocalStorage("ReloadContactList",1);$state.go("app.buzcard")})})}else{ContactsService.insertIntoGroupTable(db,data.lists.list,function(){ContactsService.getCreditParrainage(function(credit){MenuService.setLocalStorage("credit",credit);var dateSynchronisation=MenuService.getDateUS();MenuService.setLocalStorage("dateSynchronisation",dateSynchronisation);LoadingService.dismiss();MenuService.setLocalStorage("ReloadContactList",1);$state.go("app.buzcard")})})}}).error(function(data,status,headers,config){console.log("error "+status)})})})})}}).error(function(data,status,headers,config){console.log("error "+status)})}}).error(function(data,status,headers,config){console.log("error "+status)})},function(){LoadingService.error("Une erreur réseau est survenue<br>Veuillez réessayer plus tard","MenuController")})}else{}}}]);