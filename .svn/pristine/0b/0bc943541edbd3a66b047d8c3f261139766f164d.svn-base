appContext.controller("ContactShowController",["$scope","$state","ContactsService","$ionicPlatform","$cordovaSQLite","$stateParams","$rootScope","cameraService","$ionicHistory","$ionicModal","$ionicSlideBoxDelegate","ConnectionService","LoadingService","MenuService",function($scope,$state,ContactsService,$ionicPlatform,$cordovaSQLite,$stateParams,$rootScope,cameraService,$ionicHistory,$ionicModal,$ionicSlideBoxDelegate,ConnectionService,LoadingService,MenuService){$scope.showLast=false;$scope.tmp=false;var db=null;$ionicPlatform.ready(function(){if(window.cordova){db=$cordovaSQLite.openDB("buzcard.db")}else{db=window.openDatabase("buzcard.db","1","my",1024*1024*10)}getContact()});function getContact(){ContactsService.getContactbyId(db,$stateParams.id,function(result){tmpContact=result.rows.item(0);$scope.contact=result.rows.item(0);$scope.contact.last_name=removeSlashes(result.rows.item(0).last_name);$scope.contact.first_name=removeSlashes(result.rows.item(0).first_name);$scope.contact.company=removeSlashes(result.rows.item(0).company);$scope.contact.list=removeSlashes(result.rows.item(0).list);$scope.contact.lastsendemail=result.rows.item(0).lastsendemail;$scope.photoProfil=result.rows.item(0).photofilelocation;if(result.rows.item(0).lastsendemail!="")$scope.showLast=true;var idProfil=$rootScope.idProfil;$scope.tmp=true;console.log(JSON.stringify($scope.contact));$scope.contact.rendez_vous=new Date(result.rows.item(0).rendez_vous*1e3);if(result.rows.item(0).rendez_vous=="1900-01-01"||result.rows.item(0).rendez_vous=="1970-01-01"){result.rows.item(0).rendez_vous=""}if(Object.prototype.toString.call($scope.contact.rendez_vous)==="[object Date]"){if(isNaN($scope.contact.rendez_vous.getTime())){$scope.contact.rendez_vous=""}else{}}else{}})}$ionicModal.fromTemplateUrl("app/common/partials/imagepopup.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modal=modal});$scope.openModal=function(){console.log("open modal");$scope.modal.show();$ionicSlideBoxDelegate.update()};$scope.closeModal=function(){$scope.modal.hide()};$scope.$on("$destroy",function(){$scope.modal.remove()});$scope.$on("modal.hide",function(){});$scope.$on("modal.removed",function(){});$scope.$on("modal.shown",function(){console.log("Modal is shown!")});$scope.updateAndShowContact=function(id,email){LoadingService.loading("Synchronisation...");ConnectionService.isConnected(db,function(){ContactsService.getContactFromServerByEmail(email,function(contact){ContactsService.getContactbyId(db,contact.id,function(result){if(result.rows.length>0){if(ContactsService.isUpToDate(result.rows.item(0).modificationdate,contact.modificationdate)){$state.go("app.contactEdit",{id:id})}else{console.log(contact);console.log("++++++++");ContactsService.updateContactModificationDate(db,id,contact.modificationdate,function(){ContactsService.updateContactInfo(db,contact,function(){ContactsService.emptyGroupTable(db,function(){ContactsService.getGroup().success(function(data,status,headers,config){ContactsService.downloadAndOverride($stateParams.id,function(urlImage,i){ContactsService.updateContactPhoto(db,$stateParams.id,urlImage,function(){console.log("+++++=======++++++++++++++");MenuService.setLocalStorage("ReloadContactList",1);if(data.lists.list instanceof Array){for(var int=0;int<data.lists.list.length;int++)ContactsService.insertIntoGroupTable(db,data.lists.list[int],function(){LoadingService.dismiss();$state.go("app.contactEdit",{id:$stateParams.id})})}else ContactsService.insertIntoGroupTable(db,data.lists.list,function(){LoadingService.dismiss();$state.go("app.contactEdit",{id:$stateParams.id})})})})}).error(function(data,status,headers,config){console.log("error "+status)})})})})}}else{LoadingService.error("une erreur rÃ©seau est survenue","ContactShowController")}})},function(){LoadingService.dismiss();$state.go("app.contactEdit",{id:id})})},function(){LoadingService.dismiss();$state.go("app.contactEdit",{id:id})})};$scope.dismiss=function(){LoadingService.dismiss();$state.go("app.contactEdit",{id:id})}}]);