appContext.controller("ContactListController",["$scope","ContactsService","$ionicPlatform","$cordovaSQLite","LoadingService","$rootScope","cameraService","$ionicHistory","MenuService","$ionicScrollDelegate","$state","$location","$ionicPosition","$timeout",function($scope,ContactsService,$ionicPlatform,$cordovaSQLite,LoadingService,$rootScope,cameraService,$ionicHistory,MenuService,$ionicScrollDelegate,$state,$location,$ionicPosition,$timeout){var db=null;$ionicPlatform.ready(function(){if(window.cordova){db=$cordovaSQLite.openDB("buzcard.db")}else{db=window.openDatabase("buzcard.db","1","my",1024*1024*10)}$scope.shownGroup=null;MenuService.setLocalStorage("firstLoad",0)});$scope.$on("$ionicView.beforeEnter",function(scopes,states){init()});function init(){if(MenuService.getLocalStorage("firstLoad")==0||MenuService.getLocalStorage("firstLoad")==false||(MenuService.getLocalStorage("ReloadContactList")!=0||MenuService.getLocalStorage("ReloadContactList")!=false)){$ionicScrollDelegate.scrollTop();$scope.creditParrainage=MenuService.getLocalStorage("credit");var accordionNames=["Tous mes contacts","Tous mes followers"];$scope.tabs=[];$scope.groups=[];$scope.recontact={items:[],count:0,empty:true};$scope.search={name:"RÃ©sultat de recherche",items:[],empty:true};$scope.show=false;$scope.tabs[0]={id:1,items:[],count:0,page:1,totalPages:1,empty:true};$scope.tabs[1]={id:2,items:[],count:0,page:1,totalPages:1,empty:true};MenuService.setLocalStorage("firstLoad",1);MenuService.setLocalStorage("ReloadContactList",0);ContactsService.selectContacts(db,1,function(result){$scope.tabs[0].items=[];if(result.rows.length>0){$scope.tabs[0].empty=false;for(var int=0;int<result.rows.length;int++){$scope.tabs[0].items.push(result.rows.item(int))}}else{$scope.tabs[0].items.push({});$scope.tabs[0].empty=true}ContactsService.selectFollowers(db,1,function(result){$scope.tabs[1].items=[];if(result.rows.length>0){$scope.tabs[1].empty=false;for(var int=0;int<result.rows.length;int++){$scope.tabs[1].items.push(result.rows.item(int))}}else{$scope.tabs[1].items.push({});$scope.tabs[1].empty=true}ContactsService.getCountOfContact(db,"selected",function(result){var fowllowersCount=0;if(result.rows.length>0){for(var key in result.rows.item(0)){fowllowersCount=result.rows.item(0)[key];$scope.tabs[1].count=result.rows.item(0)[key];$scope.tabs[1].totalPages=guessPagesNumber($scope.tabs[1].count)}}else{$scope.tabs[1].count=0;$scope.tabs[1].empty=true}ContactsService.getCountOfContact(db,"cant_be_selected",function(result){if(result.rows.length>0){var nonFollowersCount=0;for(var key in result.rows.item(0)){nonFollowersCount=result.rows.item(0)[key]}$scope.tabs[0].count=nonFollowersCount+fowllowersCount;$scope.tabs[0].totalPages=guessPagesNumber($scope.tabs[0].count)}else{$scope.tabs[0].count=0}ContactsService.selectAllGroup(db,function(result){$scope.groupNumber=result.rows.length;if(result.rows.length>0){for(var int=0;int<result.rows.length;int++){$scope.groups[int]={name:result.rows.item(int).name,items:[]}}ContactsService.getAllContactsByGroup(db,$scope,$scope.groups.length,function(){for(var int=0;int<$scope.groups.length;int++){$scope.groups[int].nbr=guessPagesNumber($scope.groups[int].nbr);$scope.groups[int].page=1}})}else{console.log("emptyyy....")}});ContactsService.selectRecontact(db,function(result){$scope.recontact.items=[];if(result.rows.length>0){$scope.recontact.empty=false;$scope.recontact.count=result.rows.length;for(var int=0;int<result.rows.length;int++){$scope.recontact.items.push(result.rows.item(int))}}else{$scope.recontact.empty=true}})})})})})}}$scope.toggleGroup=function(group,element){if($scope.isGroupShown(group)){$scope.shownGroup=null}else{$scope.shownGroup=group}$ionicScrollDelegate.$getByHandle().scrollTop()};$scope.isGroupShown=function(group){$ionicScrollDelegate.resize();return $scope.shownGroup===group};$scope.toggleGroupX=function(group,element){if($scope.isGroupShownX(group)){$scope.shownGroupX=null}else{$scope.shownGroupX=group}console.log(element);$ionicScrollDelegate.resize();$timeout(function(){$ionicScrollDelegate.$getByHandle(element)},200)};$scope.isGroupShownX=function(group){return $scope.shownGroupX===group};$scope.btnSearch=function(criteria){$scope.search.items=[];if(!angular.equals(criteria.length,0)){ContactsService.searchContact(db,criteria,function(result){if(result.rows.length>0){$scope.show=true;$scope.search.empty=false;for(var int=0;int<result.rows.length;int++){$scope.search.items.push(result.rows.item(int))}if(!$scope.isGroupShown($scope.search)){$scope.toggleGroup($scope.search)}}else{$scope.show=true;$scope.search.empty=true;if(!$scope.isGroupShown($scope.search)){$scope.toggleGroup($scope.search)}}})}else{LoadingService.error("Veuillez remplir le champ","ContactListController")}};$scope.forwardgroups=function(i,element){if($scope.groups[i].page<$scope.groups[i].nbr){$scope.groups[i].page=$scope.groups[i].page+1;var selectQuery="SELECT * FROM contact where status != 'deleted' and list =='"+$scope.groups[i].name+"' order by date DESC LIMIT 10 OFFSET "+parseInt(10*($scope.groups[i].page-1))+";";try{$cordovaSQLite.execute(db,selectQuery).then(function(result){console.warn(selectQuery);var count=0;$scope.groups[i].items=[];for(var int=0;int<result.rows.length;int++){var tmp=result.rows.item(int);$scope.groups[i].items.push(tmp)}$location.hash(element);var handle=$ionicScrollDelegate.$getByHandle("content");handle.anchorScroll()},function(reason){console.log(reason)},function(value){console.warn(value)})}catch(e){return 0}}};$scope.rewindgroups=function(i,element){if($scope.groups[i].page>1){$scope.groups[i].page=$scope.groups[i].page-1;var selectQuery="SELECT * FROM contact where status != 'deleted' and list =='"+$scope.groups[i].name+"' order by date DESC LIMIT 10 OFFSET "+parseInt(10*($scope.groups[i].page-1))+";";try{$cordovaSQLite.execute(db,selectQuery).then(function(result){console.warn(selectQuery);var count=0;$scope.groups[i].items=[];for(var int=0;int<result.rows.length;int++){var tmp=result.rows.item(int);$scope.groups[i].items.push(tmp)}$location.hash(element);var handle=$ionicScrollDelegate.$getByHandle("content");handle.anchorScroll()},function(reason){console.log(reason)},function(value){console.warn(value)})}catch(e){return 0}}};$scope.forward=function(id){switch(id){case 0:if($scope.tabs[0].page<$scope.tabs[0].totalPages){ContactsService.selectContacts(db,$scope.tabs[0].page+1,function(result){$scope.tabs[0].items=[];if(result.rows.length>0){$scope.tabs[0].empty=false;for(var int=0;int<result.rows.length;int++){$scope.tabs[0].items.push(result.rows.item(int));$scope.dynamicTimeStamp=(new Date).getTime()}$scope.tabs[0].page++}else{$scope.tabs[0].items.push({});$scope.tabs[0].empty=true}$location.hash("TousContact");var handle=$ionicScrollDelegate.$getByHandle("content");handle.anchorScroll()})}break;case 1:if($scope.tabs[1].page<$scope.tabs[1].totalPages){ContactsService.selectContacts(db,$scope.tabs[1].page+1,function(result){$scope.tabs[1].items=[];if(result.rows.length>0){$scope.tabs[1].empty=false;for(var int=0;int<result.rows.length;int++){$scope.tabs[1].items.push(result.rows.item(int));$scope.dynamicTimeStamp=(new Date).getTime()}$scope.tabs[1].page++}else{$scope.tabs[1].items.push({});$scope.tabs[1].empty=true}$location.hash("Followers");var handle=$ionicScrollDelegate.$getByHandle("content");handle.anchorScroll()})}break}};$scope.rewind=function(id){switch(id){case 0:if($scope.tabs[0].page>1){ContactsService.selectContacts(db,$scope.tabs[0].page-1,function(result){$scope.tabs[0].items=[];if(result.rows.length>0){$scope.tabs[0].empty=false;for(var int=0;int<result.rows.length;int++){$scope.tabs[0].items.push(result.rows.item(int))}$scope.tabs[0].page--}else{$scope.tabs[0].items.push({});$scope.tabs[0].empty=true}$location.hash("TousContact");var handle=$ionicScrollDelegate.$getByHandle("content");handle.anchorScroll()})}break;case 1:if($scope.tabs[1].page>1){ContactsService.selectContacts(db,$scope.tabs[1].page-1,function(result){$scope.tabs[1].items=[];if(result.rows.length>0){$scope.tabs[1].empty=false;for(var int=0;int<result.rows.length;int++){$scope.tabs[1].items.push(result.rows.item(int))}$scope.tabs[1].page--}else{$scope.tabs[1].items.push({});$scope.tabs[1].empty=true}$location.hash("Followers");var handle=$ionicScrollDelegate.$getByHandle("content");handle.anchorScroll()})}break}};$scope.changeHandler=function(criteria){if(angular.equals(criteria.length,0)){$scope.show=false}};function guessPagesNumber(total){var div=total/10;if(parseInt(div)==div){return div}else{return parseInt(div+1)}}$scope.dismiss=function(){LoadingService.dismiss()}}]);