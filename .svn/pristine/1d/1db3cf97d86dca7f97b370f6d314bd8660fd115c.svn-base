appContext.controller("BuzcardSendController",["$cordovaDatePicker","$scope","MenuService","BuzcardService","LoadingService","$filter","ContactsService","$state","$ionicPlatform","$cordovaSQLite","$ionicHistory","$rootScope","cameraService","ConnectionService","SynchroServices",function($cordovaDatePicker,$scope,MenuService,BuzcardService,LoadingService,$filter,ContactsService,$state,$ionicPlatform,$cordovaSQLite,$ionicHistory,$rootScope,cameraService,ConnectionService,SynchroServices){if(MenuService.getLocalStorage("customisation")){var custoArray=MenuService.getLocalStorage("customisation");$scope.secondColor="1px solid "+custoArray[4];$scope.firstColor=custoArray[3]}var db=null;$scope.photoContact=null;$ionicPlatform.ready(function(){if(window.cordova){db=$cordovaSQLite.openDB("buzcard.db")}else{db=window.openDatabase("buzcard.db","1","my",1024*1024*10)}$scope.email="";$scope.dateRDV=$filter("date")(new Date,"dd/MM/yyyy");$scope.selectLang="fr";$scope.checkFollower=true});$scope.sendBuzcard=function(email,selectLang,checkFollower,dateRDV){dateRDV=$("#datepickerDirective").val();var dateRDVT=new Date(dateRDV.substr(6,4),dateRDV.substr(3,2),dateRDV.substr(0,2));MenuService.setLocalStorage("ReloadContactList",1);var checkFollowerValue="";if(checkFollower){checkFollowerValue="on"}else{checkFollowerValue="off"}var dateRDVValue="";if(dateRDV==""||dateRDV==null){dateRDVValue=$filter("date")(new Date,"dd/MM/yyyy")}else{dateRDVValue=$filter("date")(dateRDV,"dd/MM/yyyy")}if(typeof email==="undefined"||typeof email===null){LoadingService.error("Entrez l'adresse email de votre interlocuteur.","BuzcardSendController")}else if(!validateEmail(email)){LoadingService.error("L'adresse email renseignée est invalide","BuzcardSendController")}else{ConnectionService.isConnected(db,function(){LoadingService.loading("Envoi de buzcard ");if(typeof selectLang==="undefined"||typeof selectLang===null)selectLang="fr";BuzcardService.sendBuzcardToServer(email,selectLang,checkFollowerValue,dateRDVValue,function(){console.warn("send ok--+++-");ContactsService.selectContactbyEmail(db,email,function(result){LoadingService.loading("Chargement de la fiche en cours...");console.warn("select contact from db ok---");if(result.rows.length==0){ContactsService.getContactFromServerByEmail(email,function(contact){ContactsService.insertIntoContactsTable(db,contact,function(){if($scope.photoContact!=null){var idProfil=$rootScope.idProfil;var fileName=contact.id+".jpg";cameraService.RenamePicture(fileName,$scope.photoContact,function(url){ContactsService.updateContactPhoto(db,contact.id,url,function(){ContactsService.uploadPhotoContact(url,contact.id,function(){LoadingService.confirm("Votre buzcard a bien été envoyée à <br><font style='font-style: normal;color:#79A436'>"+email+"<br></font>Vous pouvez compléter sa fiche et l'affecter à un groupe",contact.id,"BuzcardSendController")},function(){console.log("erreur upload photo contact")})})})}else{LoadingService.confirm("Votre buzcard a bien été envoyée à <br><font style='font-style: normal;color:#79A436'>"+email+"</font><br>Vous pouvez compléter sa fiche et l'affecter à un groupe",contact.id,"BuzcardSendController")}})},function(){})}else{console.warn("contact already exist");var dateRdvTimeStamp=parseInt(dateRDVT.getTime()/1e3);ContactsService.updateContactLastSendAndLanguageRdv(db,result.rows.item(0).id,extractLang(selectLang),dateRdvTimeStamp,function(resX){console.log("#### resx ##### "+JSON.stringify(resX.rows.item(0))+" ######");ContactsService.updateContactStatus(db,result.rows.item(0).id,checkFollowerValue,function(){if($scope.photoContact!=null){var idProfil=$rootScope.idProfil;var fileName=result.rows.item(0).id+".jpg";cameraService.RenamePicture(fileName,$scope.photoContact,function(url){ContactsService.updateContactPhoto(db,result.rows.item(0).id,url,function(){ContactsService.uploadPhotoContact(url,result.rows.item(0).id,function(){console.log("uploaded CONTACTPHOTO");LoadingService.confirm("Votre buzcard a bien été envoyée à <br><font style='font-style: normal;color:#79A436'>"+email+"<br></font>Vous pouvez compléter sa fiche et l'affecter à un groupe",result.rows.item(0).id,"BuzcardSendController")},function(){console.log("erreur upload photo contact")})})})}else{LoadingService.confirm("Votre buzcard a bien été envoyée à <br><font style='font-style: normal;color:#79A436'>"+email+"<br></font>Vous pouvez compléter sa fiche et l'affecter à un groupe",result.rows.item(0).id,"BuzcardSendController")}})})}})},function(thrownError){console.log("erreur send buzcard"+JSON.stringify(thrownError));LoadingService.error("Une erreur réseau est survenue","BuzcardSendController")})},function(){LoadingService.loading("Votre buzcard sera envoyée à<br><font style='font-style: normal;color:#79A436'>"+email+"<br></font>dès que vous aurez à nouveau du réseau");var object={email:email,selectLang:selectLang,checkFollower:checkFollowerValue,dateRDV:dateRDVValue};SynchroServices.insertRequest(db,"BUZCARDSEND",object,function(){ContactsService.selectContactbyEmail(db,email,function(result){if(result.rows.length==0){var idTmp=parseInt((new Date).getTime()/1e3);var status="";if(checkFollowerValue=="on"){status="selected"}else{status="cant_be_selected"}var contactObj={id:idTmp,email:email,date:idTmp,rendez_vous:toUsFormat(dateRDVValue),comment:"",last_name:"",first_name:"",phone_1:"",phone_2:"",company:"",list:"",status:status,firstsendemail:$filter("date")(new Date,"MM/dd/yyyy hh:mm"),lastsendemail:"",LanguageText:extractLang(selectLang)};console.log("#### do not exist ##### "+JSON.stringify(contactObj)+" ######");ContactsService.insertIntoContactsTable(db,contactObj,function(){if($scope.photoContact!=null){var idProfil=$rootScope.idProfil;var fileName=idTmp+".jpg";cameraService.RenamePicture(fileName,$scope.photoContact,function(url){ContactsService.updateContactPhoto(db,contactObj.id,url,function(){LoadingService.confirm("Votre buzcard sera envoyée à<br><font style='font-style: normal;color:#79A436'>"+email+"<br></font>dès que vous aurez à nouveau du réseau",idTmp,"BuzcardSendController")})})}else{LoadingService.confirm("Votre buzcard sera envoyée à<br><font style='font-style: normal;color:#79A436'>"+email+"<br></font>dès que vous aurez à nouveau du réseau",idTmp,"BuzcardSendController")}})}else{contactX={id:result.rows.item(0).id,rendez_vous:$filter("date")(new Date(dateRDV),"MM/dd/yyyy"),lastsendemail:$filter("date")(new Date,"MM/dd/yyyy hh:mm"),LanguageText:extractLang(selectLang)};console.log("#### exist ##### "+JSON.stringify(contactX)+" ######");console.log($scope.photoContact);if($scope.photoContact!=null){console.log("eeeeeeeee if");var idProfil=$rootScope.idProfil;var fileName="dir"+idProfil+"/"+contactX.id+".jpg";console.log("aaaaaaa "+fileName+" aaaaaaaaa");cameraService.RenamePicture(fileName,$scope.photoContact,function(url){ContactsService.updateContactPhoto(db,contactX.id,url,function(){ContactsService.updateContactInfoNew(db,contactX,function(){delete contactX.id;delete contactX.rendez_vous;delete contactX.lastsendemail;SynchroServices.insertRequest(db,"CONTACTEDIT",{id:result.rows.item(0).id,contact:contactX},function(){LoadingService.confirm("Votre buzcard sera envoyée à<br><font style='font-style: normal;color:#79A436'>"+email+"<br></font>dès que vous aurez à nouveau du réseau",result.rows.item(0).id,"BuzcardSendController")})})})})}else{console.log("eeeeeeeee else");ContactsService.updateContactInfoNew(db,contactX,function(){delete contactX.id;delete contactX.rendez_vous;delete contactX.lastsendemail;SynchroServices.insertRequest(db,"CONTACTEDIT",{id:result.rows.item(0).id,contact:contactX},function(){LoadingService.confirm("Votre buzcard sera envoyée à<br><font style='font-style: normal;color:#79A436'>"+email+"<br></font>dès que vous aurez à nouveau du réseau",result.rows.item(0).id,"BuzcardSendController")})})}}})})})}};$scope.ok=function(id){LoadingService.dismiss();$state.go("app.contactEdit",{id:id})};$scope.dismiss=function(){LoadingService.dismiss()};$scope.getPhoto=function(){LoadingService.loading("");var options={quality:100,destinationType:Camera.DestinationType.FILE_URI,sourceType:Camera.PictureSourceType.CAMERA,encodingType:Camera.EncodingType.JPEG,targetWidth:500,targetHeight:500,correctOrientation:true,popoverOptions:CameraPopoverOptions};cameraService.getPicture(options).then(function(imageURI){$scope.photoContact=imageURI;LoadingService.dismiss()},function(err){console.error(err);LoadingService.dismiss()})};function toUsFormat(date){console.warn("initial date : "+date);var array=date.split("/");var dateTmp=array[1]+"/"+array[0]+"/"+array[2];console.log("new format : "+dateTmp);return dateTmp}function validateEmail(email){var re=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;return re.test(email)}function extractLang(lang){try{var elt=document.getElementById("selectLangId");if(elt.selectedIndex==-1)return null;return elt.options[elt.selectedIndex].text.split("/")[0]}catch(e){var elt=document.getElementById("selectLangId");return elt.options[elt.selectedIndex].text}}}]);